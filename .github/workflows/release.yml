name: Create Draft Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ v1.0.0, v2.1.3 ç­‰ï¼‰

permissions:
  contents: write  # Required for creating releases and uploading assets

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Validate required files
        run: |
          echo "æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
          REQUIRED_FILES=(
            "easytier/bin/easytier-core"
            "easytier/scripts/easytier_config.sh"
            "easytier/webs/Module_easytier.asp"
            "easytier/install.sh"
            "easytier/config.json.js"
            "easytier/.valid"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "é”™è¯¯: ç¼ºå°‘å¿…è¦æ–‡ä»¶: $file"
              exit 1
            fi
          done
          
          echo "âœ“ æ‰€æœ‰å¿…è¦æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
          
      - name: Validate required directories
        run: |
          echo "æ£€æŸ¥ç›®å½•ç»“æ„..."
          REQUIRED_DIRS=(
            "easytier/bin"
            "easytier/scripts"
            "easytier/webs"
            "easytier/res"
          )
          
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "é”™è¯¯: ç¼ºå°‘å¿…è¦ç›®å½•: $dir"
              exit 1
            fi
          done
          
          echo "âœ“ æ‰€æœ‰å¿…è¦ç›®å½•æ£€æŸ¥é€šè¿‡"
          
      - name: Build package
        run: |
          echo "å¼€å§‹æ‰“åŒ…..."
          chmod +x build_package.sh
          ./build_package.sh
          
          # éªŒè¯æ‰“åŒ…ç»“æœ
          if [ ! -f "easytier.tar.gz" ]; then
            echo "é”™è¯¯: æ‰“åŒ…å¤±è´¥"
            exit 1
          fi
          
          if [ ! -f "easytier.tar.gz.md5" ]; then
            echo "é”™è¯¯: MD5æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          echo "RELEASE_VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          
          # è·å–æ–‡ä»¶ä¿¡æ¯ç”¨äºreleaseæè¿°
          FILE_SIZE=$(ls -lh easytier.tar.gz | awk '{print $5}')
          MD5_VALUE=$(cat easytier.tar.gz.md5 | awk '{print $1}')
          
          echo "FILE_SIZE=${FILE_SIZE}" >> $GITHUB_ENV
          echo "MD5_VALUE=${MD5_VALUE}" >> $GITHUB_ENV
          
          echo "âœ“ æ‰“åŒ…å®Œæˆ"
          echo "æ–‡ä»¶å¤§å°: ${FILE_SIZE}"
          echo "MD5æ ¡éªŒ: ${MD5_VALUE}"
          
      - name: Create draft release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          tag_name: ${{ env.RELEASE_VERSION }}
          name: EasyTier KoolShare Plugin ${{ env.RELEASE_VERSION }}
          draft: true
          prerelease: false
          body: |
            # EasyTier KoolShare æ’ä»¶ ${{ env.RELEASE_VERSION }}
            
            ## ğŸ“¦ å®‰è£…åŒ…ä¿¡æ¯
            
            | é¡¹ç›® | ä¿¡æ¯ |
            |------|------|
            | **æ–‡ä»¶å** | `easytier.tar.gz` |
            | **æ–‡ä»¶å¤§å°** | `${{ env.FILE_SIZE }}` |
            | **MD5æ ¡éªŒ** | `${{ env.MD5_VALUE }}` |
            | **æ”¯æŒå¹³å°** | ARM64 (aarch64) |
            | **ç›®æ ‡è®¾å¤‡** | ASUS RT-BT86U + Merlin + KoolShare |
            
            ## ğŸš€ å®‰è£…æ–¹æ³•
            
            1. ä¸‹è½½ `easytier.tar.gz` å®‰è£…åŒ…
            2. ç™»å½•è·¯ç”±å™¨ç®¡ç†ç•Œé¢
            3. è¿›å…¥ **è½¯ä»¶ä¸­å¿ƒ** â†’ **ç¦»çº¿å®‰è£…** 
            4. ä¸Šä¼ å®‰è£…åŒ…å¹¶ç­‰å¾…å®‰è£…å®Œæˆ
            5. åœ¨è½¯ä»¶ä¸­å¿ƒæ‰¾åˆ° **EasyTier** æ’ä»¶å¹¶é…ç½®ä½¿ç”¨
            
            ## ğŸ“‹ æ–‡ä»¶è¯´æ˜
            
            - `easytier.tar.gz` - ä¸»å®‰è£…åŒ…
            - `easytier.tar.gz.md5` - MD5æ ¡éªŒæ–‡ä»¶
            
            ## âš ï¸ æ³¨æ„äº‹é¡¹
            
            - è¯·ç¡®è®¤è·¯ç”±å™¨ä¸º ARM64 æ¶æ„
            - å®‰è£…å‰å»ºè®®å¤‡ä»½å½“å‰é…ç½®
            - è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
            
            ---
            
            ğŸ”§ **æŠ€æœ¯æ”¯æŒ**: å¦‚é‡é—®é¢˜è¯·æŸ¥çœ‹ä»“åº“ Issues æˆ–å‚è€ƒæ–‡æ¡£
          files: |
            easytier.tar.gz
            easytier.tar.gz.md5

      - name: Release summary
        run: |
          echo "ğŸ‰ Draft release åˆ›å»ºæˆåŠŸ!"
          echo "ç‰ˆæœ¬: ${{ env.RELEASE_VERSION }}"
          echo "æ–‡ä»¶: easytier.tar.gz (${{ env.FILE_SIZE }})"
          echo "MD5: ${{ env.MD5_VALUE }}"
          echo ""
          echo "è¯·å‰å¾€ GitHub Releases é¡µé¢æ£€æŸ¥å¹¶å‘å¸ƒè¯¥ draft releaseã€‚"
